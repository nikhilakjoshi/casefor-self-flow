# Assumptions

- Prisma 7 uses `prisma.config.ts` for datasource URL config (not `url` in schema.prisma datasource block)
- Removed `earlyAccess` flag from prisma.config.ts - not a valid config property in current Prisma 7 types
- dotenv/config imported in prisma.config.ts to load DATABASE_URL from .env
- Fixed shadcn sidebar Math.random lint error by using fixed 70% width for skeleton
- Added npm scripts: typecheck (tsc --noEmit), test (placeholder), db:generate, db:push
- CriteriaMapping.description is non-optional String (PRD didn't specify nullability; all EB-1A criteria have descriptions)
- Document.content is optional String (allows inline storage for markdown when S3 not configured, per PRD task 13 note)
- All new fields on existing models use defaults to avoid breaking existing rows (criteriaThreshold=3, phase=ANALYSIS, applicationTypeId=null)
- Template IDs use deterministic `{applicationTypeId}-{type}` format so upserts are idempotent across re-runs
- Seed uses Node 24 `--env-file=.env` instead of dotenv (not a project dependency)
- Template content is placeholder instruction text; will be refined when evidence agent (task 11) is implemented
- Backfill sets all existing null-applicationTypeId cases to EB-1A (only app type currently supported)
- `Criterion` type uses `key` (= criterionKey) for criterion identification in prompts/analysis, `id` for DB relations
- eb1a-agent streaming functions changed from sync to async (callers must await) to support dynamic criteria loading
- analysis API now returns `criteriaNames` map so client components don't need static criteria imports
- `results-modal.tsx` criteriaNames prop is optional; falls back to raw criterionId as display name if not provided
- `lib/eb1a-criteria.ts` retained as deprecated reference file; no consumers import it
- Auto-assign uses spread conditional `...(eb1aType && { applicationTypeId: eb1aType.id })` to avoid setting undefined on the create call
- No auth check in /api/analyze (onboard flow is pre-auth, consistent with existing code pattern)
- Case status PATCH uses hardcoded z.enum(['SCREENING','ACTIVE','EVIDENCE','CLOSED']) rather than importing CaseStatus from Prisma; keeps route self-contained and avoids Prisma enum import quirks
- `updateThreshold` tool uses same 1-10 validation range as the PATCH API (task 5) for consistency
- `runCaseAgent` falls back to threshold=3 if case record not found (defensive, shouldn't happen in practice)
- Threshold is fetched via `select: { criteriaThreshold: true }` to minimize data transfer (not full case record)
- S3 client uses globalThis singleton pattern consistent w/ pinecone.ts
- AWS_S3_BUCKET added as 4th required env var (PRD only listed 3: REGION, ACCESS_KEY_ID, SECRET_ACCESS_KEY) -- bucket name needed for all S3 ops
- `uploadToS3` body accepts `Buffer | ReadableStream` (not Uint8Array/Blob) since these are the types PutObjectCommand accepts
- `buildDocumentKey()` exported as helper for the key convention; not in PRD but avoids key format duplication across consumers
- S3 URL constructed as `https://{bucket}.s3.{region}.amazonaws.com/{key}` (virtual-hosted style, standard for most regions)
- Evidence agent tools create structured markdown templates with context sections, not LLM-generated prose -- the agent itself (via conversation) guides the user through refinement
- `createEvidenceAgentTools` doesn't take `criteria` param (unlike case-agent) since evidence tools don't need criterion key enum validation
- Evidence agent fetches templates via `applicationType.cases` relation to find templates associated with the case's application type
- `draftRecommendationLetter` links to the first criterionKey's CriteriaMapping for the Document.criterionId FK; a future enhancement could support multi-criterion linking
- S3 upload in evidence tools is fire-and-forget with try/catch; if S3 fails the Document record still exists with inline content
- `generateFromTemplate` does simple {{var}} string replacement; does not use a full template engine
- Evidence chat API omits `action: 'initiate'` support (no AI-initiated evidence conversations); analysis chat has it but evidence phase is always user-initiated
- Evidence chat loads DB message history (phase=EVIDENCE) as authoritative source each request, rather than trusting client-sent messages array for conversation continuity
- File upload processing in evidence-chat reuses same pipeline (PDF extract + chunk + embed) as analysis chat; duplicated helper fns rather than extracting shared module to keep routes self-contained
- Document POST accepts .md and .markdown extensions, both map to MARKDOWN DocumentType
- Document record created before S3 upload to generate ID for `buildDocumentKey()`; if S3 upload fails the record still exists (no rollback)
- Non-markdown files without S3 configured: record exists with metadata only, no content stored (user would need to configure S3 for binary file storage)
- GET list endpoint uses `select` to return only summary fields (no content/s3Key); GET detail returns full record + signedUrl
- PATCH accepts optional content/status/name fields via Zod; at least one field required implicitly (empty object is technically valid but no-op)
- DELETE performs S3 cleanup in try/catch; if S3 delete fails, DB record is still removed to avoid orphaned records
- `verifyOwnership` helper is local to [docId]/route.ts, not extracted to shared module (only used in that file's 3 handlers)
- Threshold stepper uses optimistic update pattern: state changes immediately, reverts if PATCH fails (no loading indicator for threshold changes)
- Analysis API response includes `criteriaThreshold` alongside analysis data; ReportPanel propagates threshold changes to parent via `onThresholdChange` callback on refetch
- Onboard results-modal uses default threshold=3 since no case record exists at onboard time (threshold is only configurable post-case-creation)
- Threshold stepper positioned inline within the existing badge pill for compact layout (no separate control area)
- EvidenceChatPanel is a fully independent component (not reusing ChatPanel) because it has different API endpoint, different empty state, and evidence-specific drag-drop; shared ChatInput/MessageItem components are reused
- DocumentsPanel detail view uses inline back button (X) rather than browser navigation; no router state involved
- Analysis messages query now explicitly filters `phase: 'ANALYSIS'` to avoid showing evidence messages in analysis tab; backward-compatible because existing messages have phase=ANALYSIS by default
- PhaseTabs positioned in a top bar above the 60/40 split content area; tab state lives in client.tsx (not URL-based)
- DocumentsPanel does not have a loading indicator for detail fetch (fetch is fast, keeps UI simple)
- Evidence tab re-mounts EvidenceChatPanel when switching tabs; initialMessages from server are used as starting state (subsequent messages from same session are in component state only, will persist on re-mount from server data on next page load)
- Evidence badge uses `onStrongCountChange` callback from ReportPanel rather than computing strongCount independently in client.tsx; avoids duplicating analysis fetch logic
- Badge dismissal (`badgeDismissed`) is session-only; reappears on page reload if threshold still met -- intentional to allow re-entry to evidence phase
- PATCH to set case status=EVIDENCE is fire-and-forget (tab switches regardless); status update is best-effort
- Badge positioned `bottom-20` (80px from bottom) to float above ChatInput; uses absolute positioning within the chat panel column
- Admin sidebar includes /admin/application-types nav link proactively (task 18 page doesn't exist yet); link will 404 until implemented
- Admin layout uses same SidebarProvider + SidebarInset pattern as case layout; no shared layout extraction (admin and case have different sidebars)
- Admin dashboard has no auth guard per PRD resolved decisions; open access for v1
- AdminSidebar active state: exact match for /admin dashboard, startsWith for sub-pages (prevents /admin/criteria from highlighting both Dashboard and Criteria)
- Admin criteria API has no auth guard, consistent with admin layout (task 15) open-access decision
- POST /api/admin/criteria catches Prisma P2002 error code to return 409 on duplicate (applicationTypeId, criterionKey) pairs
- Admin criteria page is a client component (not server) since it needs inline editing state; initial data fetched client-side
- Used useRef didFetch guard to prevent double-fetch in React strict mode and to satisfy react-hooks/set-state-in-effect lint rule
- Active toggle in criteria table works both inline (during edit) and standalone (click toggles + PATCHes immediately); two separate code paths for clarity
- Criteria table groups by applicationTypeId; if multiple app types exist, each gets its own section with header
- Admin templates [id] route includes GET handler (not in PRD steps) since edit page needs to fetch template by id
- Template applicationTypeId is read-only on edit page; changing it could break template-appType relationships and is not a common admin action
- Templates list page uses native `<select>` element instead of shadcn Select (not installed, keeps it simple)
- Content textarea uses monospace font since template content is instruction text / markdown
- Admin templates API has no auth guard, consistent with admin layout (task 15) and criteria API (task 16) open-access decision
- Admin application-types API has no auth guard, consistent with all other admin endpoints
- POST /api/admin/application-types catches Prisma P2002 for duplicate code uniqueness constraint (same pattern as criteria API)
- GET includes `_count` for criteria and cases only (not templates); PRD specified "criteria and cases"
- defaultThreshold on POST validated 1-10, consistent with threshold PATCH API (task 5)
- Recommender.durationYears is Float (not Int) to support partial years like 2.5
- Recommender.contextNotes is optional Json for freeform storage of nuanced relationship details
- Documents can be linked to recommenders via recommenderId FK; allows tracking which recommendation letters belong to which recommender
- Used `prisma db push` instead of `prisma migrate dev` for schema sync (faster, no migration file needed in dev)
- Recommender API POST uses spread conditional for contextNotes to avoid Prisma nullable Json type issues: `...(data.contextNotes && { contextNotes: data.contextNotes as Prisma.InputJsonValue })`
- Recommender API validates date strings as ISO datetime format via `z.string().datetime()` before converting to Date objects
- Recommender [recommenderId] PATCH uses explicit field-by-field update to correctly distinguish between undefined (not provided) and null (explicitly clear)
- contextNotes clearing uses Prisma.DbNull when explicitly passed as null; required value import from '@prisma/client' (not type-only import)
- verifyOwnership helper kept local to [recommenderId]/route.ts to match documents/[docId] pattern (not extracted to shared module)
- Zod 4 requires two arguments for `z.record()`: key schema and value schema (e.g., `z.record(z.string(), z.unknown())`)
- saveRecommender tool uses RelationshipType enum imported from @prisma/client (not redefined as Zod enum)
- draftRecommendationLetter now requires EITHER recommenderId OR all three manual inputs (name, title, relation) - returns error if neither provided
- listRecommenders includes document count via `_count.documents` to show recommender utilization
- getRecommender includes linked documents via `include: { documents: true }` for full context
- draftRecommendationLetter builds richer specificInstructions when recommender has bio/credentials/contextNotes stored
- Recommender tools added to existing createEvidenceAgentTools function (not a separate tools object)
- RecommenderForm uses native `<select>` for relationshipType dropdown (no shadcn Select component installed)
- RecommendersPanel uses didFetchRef guard pattern to prevent double-fetch in React strict mode
- DocumentsPanel tabs are local component state; not persisted/URL-based
- Generate Letter button not included in RecommendersPanel -- evidence agent handles letter generation via chat interaction
- PanelTabs component is local to documents-panel.tsx (not extracted to shared component)
- RecommendersPanel re-mounts when switching tabs (fresh state); initial data fetched on mount each time
- `parseExcel` uses dynamic import to avoid bundling xlsx library on routes that don't need it
- CSV parser uses simple quote-toggle logic for quoted fields; does not handle escaped quotes ("") within quoted fields
- `.markdown` extension maps to 'md' file type (same as `.md`)
- Empty Excel sheets are skipped silently; error only thrown if all sheets are empty
- Markdown minimum length validation (100 chars) applies same as txt files; intended to catch corrupted/empty files
- Multi-file upload API expects FormData key 'files' (plural); single-file 'file' key is deprecated
- processFile runs incremental analysis synchronously (awaits completion) to capture accurate status; differs from old fire-and-forget pattern
- MAX_FILES=10 is a constant in upload route; not configurable via env var
- Multi-file upload UI uses two-step flow: drop files to queue, click Upload to process -- allows removing files before upload
- File matching in batch response uses fileName; assumes unique names within batch (duplicate names may cause mismatched status updates)
- Retry button for failed files not implemented; user can re-drop failed files instead
- Upload button shows dynamic count of pending files (e.g., "Upload 3 file(s)")
- "Clear completed" button only appears when at least one file succeeded
- New DocumentCategory values placed before OTHER to keep OTHER as the last/catch-all value
- Classifier schema updated to include PERSONAL_STATEMENT and PETITION_LETTER which existed in DB enum but were missing from classifier (consistency fix bundled w/ new categories)
- G1450 form variants (G1450PPU, G1450300, G1450I40) use PRD naming convention as-is; these map to USCIS G-1450 Authorization for Credit Card Transactions with different fee designations
- Filename pattern hints in classifier prompt are advisory guidance to LLM, not programmatic matching; LLM uses both filename and content for classification
- CriteriaKeys on Recommender uses C1-C10 format (from CRITERIA_LABELS in evidence-verification-schema.ts), not the DB criterionKey format (awards, membership, etc.) -- consistent with how criteria routing and evidence verification reference criteria
- Criteria list in RecommenderForm is static (C1-C10 from CRITERIA_LABELS), not dynamically fetched from case's EB1AAnalysis; EB-1A always has exactly 10 criteria so dynamic fetch is unnecessary overhead
- `@default([])` on criteriaKeys means existing recommenders get empty array; no backfill needed
- POST API defaults criteriaKeys to [] via Zod `.default([])`; PATCH treats it as optional (only updates when provided)
- Criteria pills on recommender cards truncate at 3 and show "+N more" for overflow; full labels available via title tooltip
- CriteriaTab uses `criteriaContent: React.ReactNode` prop rather than duplicating CriterionSection rendering logic; keeps analysis state management in report-panel
- Old URL subtab values "strength", "gap", "strategy" fall back to "summary" default; no backward-compatibility shim needed since these are session-only URL params not persisted/shared
- Collapsible sections in CriteriaTab/PlanningTab use manual useState + conditional rendering rather than Radix Collapsible primitive; sub-panels manage their own scroll/overflow internally and work better without Collapsible animation wrapper
- PlanningTab derives `hasGapAnalysis` for CaseStrategyPanel from `!!initialGapAnalysis` rather than accepting it as a separate prop; reduces prop surface
- ConsolidationTab accepts `initialCaseStrategy` as boolean (not full CaseStrategy object) since CaseConsolidationPanel only needs `hasCaseStrategy: boolean`; report-panel derives it via `!!initialCaseStrategy`
- Old URL subtab value "consolidated-strategy" falls back to "summary" default; no backward-compatibility shim needed (session-only URL params)
- Old generic "USCIS Form" card (category: null) replaced with individual form cards per USCIS form type (I140, I907, G28, G1450PPU, G1450300, G1450I40); no backward-compat needed since old card had no real functionality
- Documents POST API `category` field is a raw string cast to `DocumentCategory` enum; no Zod validation against enum values since UI sends known enum strings
- When `category` is provided in FormData, auto-classification via `classifyDocument` is skipped (user/UI explicitly set the category)
- UploadOnlyCard uses native HTML drag-drop (onDragOver/onDrop) instead of react-dropzone; simpler for single-file uploads and avoids adding per-card dropzone instances
- RESUME_CV not included in LETTER_TYPES yet; deferred to R1 implementation (skip-to-survey, resume upload/generation)
- RecommenderCard defaults to expanded=true since recommender sub-cards are the primary interactive content; other card types default to collapsed since file lists are secondary
- Expandable cards use manual useState + conditional rendering (not Radix Collapsible) for consistency w/ CriteriaTab/PlanningTab/ConsolidationTab pattern
- Click-to-expand only enabled when docs exist (no chevron shown on empty cards); prevents confusing toggle on empty state
- UploadOnlyCard auto-expands on successful upload so user sees the newly uploaded file immediately
- stopPropagation on action buttons (Upload/Draft/Add/Import CSV) prevents header click-to-toggle when clicking buttons
- USCIS URLs use form landing pages (e.g., /i-140, /g-28) not direct PDF URLs; landing pages include filing instructions and link to the fillable PDF
- G-1450 variants (PPU, 300, I40) all share the same USCIS URL (/g-1450) since they are the same form used for different fee designations
- "Fill on USCIS" link uses native `<a>` tag styled as outline button (not shadcn Button) to avoid button-inside-link accessibility issues
- uscisUrl field is optional on LetterType; only upload-only USCIS form cards set it (draftable cards don't need external form links)
