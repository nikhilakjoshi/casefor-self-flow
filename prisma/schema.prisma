generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// NextAuth required models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  passwordHash  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]
  cases          Case[]
  invitedShares      DocumentShare[] @relation("InvitedShares")
  receivedShares     DocumentShare[] @relation("ReceivedShares")
  signatureRequests  SignatureRequest[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@index([email])
}

enum CaseStatus {
  SCREENING
  ACTIVE
  EVIDENCE
  CLOSED
}

enum ChatPhase {
  ANALYSIS
  EVIDENCE
  DOCUMENTS
  DRAFTING
}

enum IntakeStatus {
  PENDING
  PARTIAL
  COMPLETED
  SKIPPED
}

enum TemplateType {
  PERSONAL_STATEMENT
  RECOMMENDATION_LETTER
  PETITION
  USCIS_FORM
  COVER_LETTER
  USCIS_ADVISORY
  OTHER
}

enum DocumentType {
  MARKDOWN
  DOCX
  PDF
  IMAGE
}

enum DocumentSource {
  SYSTEM_GENERATED
  USER_UPLOADED
}

enum DocumentStatus {
  DRAFT
  FINAL
}

enum DocumentCategory {
  RESUME_CV
  EXECUTIVE_RESUME
  AWARD_CERTIFICATE
  PUBLICATION
  MEDIA_COVERAGE
  PATENT
  RECOMMENDATION_LETTER
  MEMBERSHIP_CERTIFICATE
  EMPLOYMENT_VERIFICATION
  SALARY_DOCUMENTATION
  CITATION_REPORT
  JUDGING_EVIDENCE
  PERSONAL_STATEMENT
  PETITION_LETTER
  PASSPORT_ID
  DEGREE_CERTIFICATE
  COVER_LETTER
  USCIS_ADVISORY_LETTER
  G1450PPU
  G1450300
  G1450I40
  G28
  I140
  I907
  I20
  VISA_STAMP
  I797_APPROVAL
  I94
  DS2019
  EAD_CARD
  NATIONAL_ID
  G1145
  G1450
  I797C_RECEIPT
  I797E_RFE
  RFE_RESPONSE
  NOID
  TRANSFER_NOTICE
  INTERVIEW_NOTICE
  BIOMETRICS_NOTICE
  I485
  I485_SUPPLEMENT_J
  I765
  I131
  PASSPORT_PHOTOS
  BIRTH_CERTIFICATE
  MARRIAGE_CERTIFICATE
  DIVORCE_DECREE
  NAME_CHANGE_ORDER
  I693
  VACCINATION_RECORDS
  EMPLOYMENT_CONTRACT
  OFFER_LETTER
  TAX_RETURNS
  W2_FORMS
  PAY_STUBS
  CREDENTIAL_EVALUATION
  PROFESSIONAL_LICENSE
  OTHER
}

enum RelationshipType {
  ACADEMIC_ADVISOR
  RESEARCH_COLLABORATOR
  INDUSTRY_COLLEAGUE
  SUPERVISOR
  MENTEE
  CLIENT
  PEER_EXPERT
  OTHER
}

model Case {
  id                 String       @id @default(cuid())
  userId             String?
  name               String?
  status             CaseStatus   @default(SCREENING)
  intakeStatus       IntakeStatus @default(PENDING)
  skippedSections    String[]     @default([])
  criteriaThreshold  Int          @default(3)
  applicationTypeId  String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  user            User?            @relation(fields: [userId], references: [id])
  applicationType ApplicationType? @relation(fields: [applicationTypeId], references: [id])
  profile         CaseProfile?
  resumeUploads   ResumeUpload[]
  eb1aAnalyses    EB1AAnalysis[]
  chatMessages    ChatMessage[]
  documents       Document[]
  signatureRequests SignatureRequest[]
  recommenders           Recommender[]
  strengthEvaluations    StrengthEvaluation[]
  gapAnalyses            GapAnalysis[]
  caseStrategies         CaseStrategy[]
  evidenceVerifications  EvidenceVerification[]
  caseConsolidations    CaseConsolidation[]
  denialProbabilities   DenialProbability[]
  packageVersions       PackageVersion[]
}

model CaseProfile {
  id        String   @id @default(cuid())
  caseId    String   @unique
  data      Json     @default("{}")
  version   Int      @default(1)
  updatedAt DateTime @updatedAt

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
}

enum ChatRole {
  USER
  ASSISTANT
}

model ChatMessage {
  id         String    @id @default(cuid())
  caseId     String
  role       ChatRole
  content    String
  metadata   Json?
  phase      ChatPhase @default(ANALYSIS)
  documentId String?
  createdAt  DateTime  @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
  @@index([caseId, documentId])
}

model ResumeUpload {
  id               String   @id @default(cuid())
  caseId           String
  fileName         String
  fileSize         Int
  pineconeVectorIds String[]
  createdAt        DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
}

model EB1AAnalysis {
  id               String   @id @default(cuid())
  caseId           String
  version          Int      @default(1)
  criteria         Json
  extraction       Json?
  mergedWithSurvey Boolean  @default(false)
  surveyVersion    Int?
  strongCount      Int
  weakCount        Int
  createdAt        DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
}

model ApplicationType {
  id               String   @id @default(cuid())
  code             String   @unique
  name             String
  defaultThreshold Int      @default(3)
  active           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  criteria  CriteriaMapping[]
  templates Template[]
  cases     Case[]
}

model CriteriaMapping {
  id                String   @id @default(cuid())
  applicationTypeId String
  criterionKey      String
  name              String
  description       String
  displayOrder      Int      @default(0)
  active            Boolean  @default(true)

  applicationType ApplicationType @relation(fields: [applicationTypeId], references: [id])
  documents       Document[]

  @@unique([applicationTypeId, criterionKey])
}

model Template {
  id                String       @id @default(cuid())
  name              String
  type              TemplateType
  applicationTypeId String
  description       String?
  systemInstruction String  @default("")
  version           Int          @default(1)
  active            Boolean      @default(true)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  applicationType ApplicationType @relation(fields: [applicationTypeId], references: [id])
  documents       Document[]
  variations      TemplateVariation[]
}

model TemplateVariation {
  id         String   @id @default(cuid())
  templateId String
  label      String
  content    String
  matchField String
  matchValue String
  isDefault  Boolean  @default(false)
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model Document {
  id            String         @id @default(cuid())
  caseId        String
  name          String
  type          DocumentType
  source        DocumentSource
  s3Key         String?
  s3Url         String?
  criterionId   String?
  templateId    String?
  recommenderId String?
  content       String?
  status                   DocumentStatus @default(DRAFT)
  category                 DocumentCategory?
  classificationConfidence Float?
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt

  case        Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  criterion   CriteriaMapping? @relation(fields: [criterionId], references: [id])
  template    Template?        @relation(fields: [templateId], references: [id])
  recommender Recommender?     @relation(fields: [recommenderId], references: [id])
  evidenceVerifications EvidenceVerification[]
  criterionRoutings     DocumentCriterionRouting[]
  shares                DocumentShare[]
  signatureRequests     SignatureRequest[]

  @@index([caseId])
}

model DocumentVerification {
  id              String   @id @default(cuid())
  caseId          String
  assessments     Json     // Map of documentId -> { strength, feedback }
  overallStrength String
  overallFeedback String
  createdAt       DateTime @default(now())

  @@index([caseId, createdAt])
}

model Recommender {
  id                  String           @id @default(cuid())
  caseId              String
  name                String
  title               String
  relationshipType    RelationshipType
  relationshipContext String
  email               String?
  phone               String?
  linkedIn            String?
  countryRegion       String?
  organization        String?
  bio                 String?
  credentials         String?
  startDate           DateTime?
  endDate             DateTime?
  durationYears       Float?
  contextNotes        Json?
  criteriaKeys        String[]         @default([])
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  case      Case       @relation(fields: [caseId], references: [id], onDelete: Cascade)
  documents Document[]

  @@index([caseId])
}

model StrengthEvaluation {
  id        String   @id @default(cuid())
  caseId    String
  version   Int      @default(1)
  data      Json
  createdAt DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model GapAnalysis {
  id        String   @id @default(cuid())
  caseId    String
  version   Int      @default(1)
  data      Json
  createdAt DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model CaseStrategy {
  id        String   @id @default(cuid())
  caseId    String
  version   Int      @default(1)
  data      Json
  createdAt DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model EvidenceVerification {
  id             String   @id @default(cuid())
  caseId         String
  documentId     String
  criterion      String
  version        Int      @default(1)
  data           Json
  score          Float
  recommendation String
  createdAt      DateTime @default(now())

  case     Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, criterion, version])
  @@index([caseId])
  @@index([documentId])
}

model DocumentCriterionRouting {
  id             String   @id @default(cuid())
  documentId     String
  criterion      String
  score          Float
  recommendation String
  autoRouted     Boolean  @default(true)
  matchedItemIds String[] @default([])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, criterion])
  @@index([documentId])
  @@index([criterion])
}

model CaseConsolidation {
  id        String   @id @default(cuid())
  caseId    String
  version   Int      @default(1)
  data      Json
  createdAt DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model DenialProbability {
  id        String   @id @default(cuid())
  caseId    String
  version   Int      @default(1)
  data      Json
  createdAt DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model PackageVersion {
  id        String   @id @default(cuid())
  caseId    String
  version   Int      @default(1)
  label     String?
  data      Json
  createdAt DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model AgentPrompt {
  id             String   @id @default(cuid())
  slug           String   @unique
  name           String
  description    String?
  category       String   // "static" | "dynamic-system" | "dynamic-user"
  content        String
  defaultContent String   @default("")
  variables      Json     @default("[]") // [{key, label, description}]
  provider       String   @default("anthropic") // "anthropic" | "google"
  modelName      String   @default("claude-sonnet-4-20250514")
  temperature    Float?
  maxTokens      Int?
  active         Boolean  @default(true)
  usageGroup     String   @default("uncategorized")
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  versions AgentPromptVersion[]
}

model AgentPromptVersion {
  id          String   @id @default(cuid())
  promptId    String
  version     Int
  content     String
  provider    String
  modelName   String
  temperature Float?
  maxTokens   Int?
  createdAt   DateTime @default(now())

  prompt AgentPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@unique([promptId, version])
  @@index([promptId, version])
}

enum SharePermission {
  VIEW
  EDIT
  FULL
}

enum ShareStatus {
  PENDING
  ACCEPTED
  REVOKED
}

model DocumentShare {
  id           String          @id @default(cuid())
  documentId   String
  caseId       String
  inviterId    String
  inviteeEmail String
  inviteeId    String?
  permission   SharePermission
  status       ShareStatus     @default(PENDING)
  token        String          @unique
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  inviter  User     @relation("InvitedShares", fields: [inviterId], references: [id])
  invitee  User?    @relation("ReceivedShares", fields: [inviteeId], references: [id])

  @@unique([documentId, inviteeEmail])
  @@index([inviteeEmail])
  @@index([inviteeId])
  @@index([token])
}

enum SignatureRequestStatus {
  PENDING
  COMPLETED
  DECLINED
  EXPIRED
  VOIDED
}

enum SignerStatus {
  PENDING
  SENT
  OPENED
  COMPLETED
  DECLINED
}

model SignatureRequest {
  id                    String                 @id @default(cuid())
  caseId                String
  documentId            String
  docusealSubmissionId  Int                    @unique
  status                SignatureRequestStatus @default(PENDING)
  sentByUserId          String
  signedDocumentS3Key   String?
  signedDocumentS3Url   String?
  auditLogUrl           String?
  expiresAt             DateTime?
  completedAt           DateTime?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  case     Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sentBy   User     @relation(fields: [sentByUserId], references: [id])
  signers  Signer[]

  @@index([caseId])
  @@index([documentId])
}

model Signer {
  id                   String       @id @default(cuid())
  signatureRequestId   String
  docusealSubmitterId  Int          @unique
  slug                 String
  role                 String
  email                String
  name                 String
  status               SignerStatus @default(PENDING)
  signedAt             DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  signatureRequest SignatureRequest @relation(fields: [signatureRequestId], references: [id], onDelete: Cascade)

  @@index([signatureRequestId])
  @@index([email])
}
