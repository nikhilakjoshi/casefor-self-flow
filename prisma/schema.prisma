generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// NextAuth required models
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  passwordHash  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  cases    Case[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@index([email])
}

enum CaseStatus {
  SCREENING
  ACTIVE
  EVIDENCE
  CLOSED
}

enum ChatPhase {
  ANALYSIS
  EVIDENCE
  DOCUMENTS
}

enum IntakeStatus {
  PENDING
  PARTIAL
  COMPLETED
  SKIPPED
}

enum TemplateType {
  PERSONAL_STATEMENT
  RECOMMENDATION_LETTER
  PETITION
  USCIS_FORM
  OTHER
}

enum DocumentType {
  MARKDOWN
  DOCX
  PDF
}

enum DocumentSource {
  SYSTEM_GENERATED
  USER_UPLOADED
}

enum DocumentStatus {
  DRAFT
  FINAL
}

enum RelationshipType {
  ACADEMIC_ADVISOR
  RESEARCH_COLLABORATOR
  INDUSTRY_COLLEAGUE
  SUPERVISOR
  MENTEE
  CLIENT
  PEER_EXPERT
  OTHER
}

model Case {
  id                 String       @id @default(cuid())
  userId             String?
  name               String?
  status             CaseStatus   @default(SCREENING)
  intakeStatus       IntakeStatus @default(PENDING)
  skippedSections    String[]     @default([])
  criteriaThreshold  Int          @default(3)
  applicationTypeId  String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  user            User?            @relation(fields: [userId], references: [id])
  applicationType ApplicationType? @relation(fields: [applicationTypeId], references: [id])
  profile         CaseProfile?
  resumeUploads   ResumeUpload[]
  eb1aAnalyses    EB1AAnalysis[]
  chatMessages    ChatMessage[]
  documents       Document[]
  recommenders           Recommender[]
  strengthEvaluations    StrengthEvaluation[]
  gapAnalyses            GapAnalysis[]
}

model CaseProfile {
  id        String   @id @default(cuid())
  caseId    String   @unique
  data      Json     @default("{}")
  version   Int      @default(1)
  updatedAt DateTime @updatedAt

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
}

enum ChatRole {
  USER
  ASSISTANT
}

model ChatMessage {
  id        String    @id @default(cuid())
  caseId    String
  role      ChatRole
  content   String
  metadata  Json?
  phase     ChatPhase @default(ANALYSIS)
  createdAt DateTime  @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model ResumeUpload {
  id               String   @id @default(cuid())
  caseId           String
  fileName         String
  fileSize         Int
  pineconeVectorIds String[]
  createdAt        DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
}

model EB1AAnalysis {
  id               String   @id @default(cuid())
  caseId           String
  version          Int      @default(1)
  criteria         Json
  extraction       Json?
  mergedWithSurvey Boolean  @default(false)
  surveyVersion    Int?
  strongCount      Int
  weakCount        Int
  createdAt        DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
}

model ApplicationType {
  id               String   @id @default(cuid())
  code             String   @unique
  name             String
  defaultThreshold Int      @default(3)
  active           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  criteria  CriteriaMapping[]
  templates Template[]
  cases     Case[]
}

model CriteriaMapping {
  id                String   @id @default(cuid())
  applicationTypeId String
  criterionKey      String
  name              String
  description       String
  displayOrder      Int      @default(0)
  active            Boolean  @default(true)

  applicationType ApplicationType @relation(fields: [applicationTypeId], references: [id])
  documents       Document[]

  @@unique([applicationTypeId, criterionKey])
}

model Template {
  id                String       @id @default(cuid())
  name              String
  type              TemplateType
  applicationTypeId String
  description       String?
  systemInstruction String  @default("")
  version           Int          @default(1)
  active            Boolean      @default(true)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  applicationType ApplicationType @relation(fields: [applicationTypeId], references: [id])
  documents       Document[]
  variations      TemplateVariation[]
}

model TemplateVariation {
  id         String   @id @default(cuid())
  templateId String
  label      String
  content    String
  matchField String
  matchValue String
  isDefault  Boolean  @default(false)
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model Document {
  id            String         @id @default(cuid())
  caseId        String
  name          String
  type          DocumentType
  source        DocumentSource
  s3Key         String?
  s3Url         String?
  criterionId   String?
  templateId    String?
  recommenderId String?
  content       String?
  status        DocumentStatus @default(DRAFT)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  case        Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  criterion   CriteriaMapping? @relation(fields: [criterionId], references: [id])
  template    Template?        @relation(fields: [templateId], references: [id])
  recommender Recommender?     @relation(fields: [recommenderId], references: [id])

  @@index([caseId])
}

model DocumentVerification {
  id              String   @id @default(cuid())
  caseId          String
  assessments     Json     // Map of documentId -> { strength, feedback }
  overallStrength String
  overallFeedback String
  createdAt       DateTime @default(now())

  @@index([caseId, createdAt])
}

model Recommender {
  id                  String           @id @default(cuid())
  caseId              String
  name                String
  title               String
  relationshipType    RelationshipType
  relationshipContext String
  email               String?
  phone               String?
  linkedIn            String?
  countryRegion       String?
  organization        String?
  bio                 String?
  credentials         String?
  startDate           DateTime?
  endDate             DateTime?
  durationYears       Float?
  contextNotes        Json?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  case      Case       @relation(fields: [caseId], references: [id], onDelete: Cascade)
  documents Document[]

  @@index([caseId])
}

model StrengthEvaluation {
  id        String   @id @default(cuid())
  caseId    String
  version   Int      @default(1)
  data      Json
  createdAt DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model GapAnalysis {
  id        String   @id @default(cuid())
  caseId    String
  version   Int      @default(1)
  data      Json
  createdAt DateTime @default(now())

  case Case @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}
